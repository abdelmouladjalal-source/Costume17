<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>مخزون القمصان</title>
    <style>
        /* الأنماط المضمنة (CSS) */
        body{font-family:Arial;direction:rtl;background:#f4f4f4;margin:0;padding:0;}
        .container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:8px}
        h2{text-align:center;margin-bottom:15px;}
        table{width:100%;border-collapse:collapse;margin-top:15px}
        th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:14px;}
        .available{background:#e8ffe8}
        .unavailable{background:#ffd6d6} 
        button{padding:7px 12px;margin:5px;background:#3498db;color:#fff;border:none;cursor:pointer;border-radius:4px;}
        button:hover{opacity:0.85;}
        .add-item-form{background:#f9f9f9; padding:15px; border-radius:4px; margin-bottom:20px;}
        .add-item-form input{padding:8px; border:1px solid #ccc; border-radius:3px;}
    </style>
</head>
<body>

<div class="container">
    <h2>مخزون القمصان (إضافة يدوية)</h2>

    <div class="add-item-form">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
            <input id="itemName" placeholder="اسم القطعة (مثال: قميص 10)" style="flex:2;">
            <input id="itemSize" placeholder="المقاس (مثال: M أو S-XL)" style="flex:1; max-width:150px;">
            <input id="itemColor" placeholder="اللون (مثل أبيض)" style="flex:1; max-width:150px;">
            <button onclick="addItem()" style="flex:1; max-width:150px; background:#27ae60;">+ إضافة قطعة</button>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>الاسم</th>
                <th>المقاس</th>
                <th>اللون</th> 
                <th>الحالة</th>
                <th>حذف</th>
            </tr>
        </thead>
        <tbody id="stockBody"></tbody>
    </table>
    <button onclick="window.location.href='inventory_management.html'">رجوع للصفحة الرئيسية</button>
</div>

<script>
const STOCK_TYPE = "shirts";
const SIZE_ORDER = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'];

function getStock() {
    let stock = JSON.parse(localStorage.getItem(STOCK_TYPE)) || [];
    return stock.map((item, index) => ({
        ...item,
        rentedPeriods: item.rentedPeriods || [], 
        id: item.id !== undefined ? item.id : index 
    }));
}

function saveStock(stock) {
    localStorage.setItem(STOCK_TYPE, JSON.stringify(stock));
}

function checkCurrentStatus(item) {
    const todayStr = new Date().toISOString().split('T')[0];
    const periods = item.rentedPeriods || [];

    for (const period of periods) {
        if (period.isReturned) continue; 
        
        const periodStart = period.start;
        const periodEnd = period.end;

        if (todayStr >= periodStart && todayStr < periodEnd) {
            return "مؤجر حالياً";
        }
    }
    return "متوفر";
}

// =======================================================
// ===== دالة إضافة المخزون (بالمقاسات النصية وبدون إشعار نجاح) =====
// =======================================================

function addItem() {
    const name = document.getElementById("itemName").value.trim();
    const sizeInput = document.getElementById("itemSize").value.trim().toUpperCase();
    const color = document.getElementById("itemColor").value.trim();
    
    if (!name || !sizeInput || !color) {
        alert("الرجاء إدخال الاسم والمقاس واللون.");
        return;
    }
    
    let stock = getStock();
    let sizesToAdd = [];

    // 1. تحليل حقل المقاس لتحديد النطاق
    const rangeMatch = sizeInput.match(/^([A-Z]+)[-–]([A-Z]+)$/);

    if (rangeMatch) {
        const startSize = rangeMatch[1];
        const endSize = rangeMatch[2];

        const startIndex = SIZE_ORDER.indexOf(startSize);
        const endIndex = SIZE_ORDER.indexOf(endSize);

        if (startIndex === -1 || endIndex === -1) {
            alert(`خطأ: أحد المقاسات (${startSize} أو ${endSize}) غير صحيح أو خارج النطاق المسموح به.`);
            return;
        }

        if (startIndex > endIndex) {
            alert("المقاس الأول يجب أن يكون أصغر أو يساوي المقاس الثاني في الترتيب (XS, S, M, L...).");
            return;
        }

        // استخراج المقاسات من المصفوفة بين نقطة البداية والنهاية
        for (let i = startIndex; i <= endIndex; i++) {
            sizesToAdd.push(SIZE_ORDER[i]);
        }

    } else {
        // إذا كان مقاساً واحداً فقط
        if (SIZE_ORDER.includes(sizeInput)) {
             sizesToAdd.push(sizeInput);
        } else {
            alert(`خطأ: المقاس المدخل (${sizeInput}) غير صحيح أو غير متوقع.`);
            return;
        }
    }
    
    // 2. إنشاء القطع وإضافتها إلى المخزون
    const itemsAddedCount = sizesToAdd.length;
    
    sizesToAdd.forEach(size => {
        const newItem = {
            name: name,
            size: size, 
            color: color,
            rentedPeriods: [], 
            id: Date.now() + Math.random() 
        };
        stock.push(newItem);
    });

    saveStock(stock); 
    renderStock(); 
    
    // مسح الحقول بعد الإضافة
    document.getElementById("itemName").value = "";
    document.getElementById("itemSize").value = "";
    document.getElementById("itemColor").value = "";

    // تم حذف إشعار النجاح (alert)
}

function deleteItem(index) {
    let stock = getStock();
    
    const currentStatus = checkCurrentStatus(stock[index]); 

    if (currentStatus === "مؤجر حالياً") {
        console.error("ERROR: لا يمكن حذف هذه القطعة. يجب إرجاعها أولاً.");
        return;
    }
    
    stock.splice(index, 1);
    
    saveStock(stock);
    renderStock();
}


function renderStock(){
    let stock = getStock(); 
    let tbody = document.getElementById("stockBody");
    tbody.innerHTML = "";

    if (stock.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">المخزون فارغ. يمكنك البدء بإضافة قطع جديدة.</td></tr>';
        return;
    }

    stock.forEach((item, index) => {
        const currentStatus = checkCurrentStatus(item); 
        
        let statusClass = currentStatus === "متوفر" ? "available" : "unavailable";
        
        let deleteButton = currentStatus === "مؤجر حالياً" 
            ? `<button disabled style="background:#ccc; cursor:not-allowed;">مؤجرة</button>`
            : `<button onclick="deleteItem(${index})" style="background:#c0392b;">حذف</button>`;
        
        tbody.innerHTML += `
            <tr class="${statusClass}">
                <td>${item.name}</td>
                <td>${item.size || "-"}</td>
                <td>${item.color || "-"}</td> 
                <td>${currentStatus}</td> 
                <td>${deleteButton}</td>
            </tr>
        `;
    });
}

renderStock();
</script>

</body>
</html>
